
# Table of Contents

1.  [cellxgene proxy setup](#org8535249)
    1.  [etc/cellxgene<sub>templates</sub>](#org70b949b)
        1.  [group<sub>to</sub><sub>port.map</sub> defines group to port location](#org2593de5)
        2.  [mkcellxgene<sub>config.pl</sub>](#org9d9afed)
        3.  [Apache2 template](#orga8e4ab3)
        4.  [systemd.service template:](#org2413369)
    2.  [var/www/](#org90a423a)
    3.  [etc/apache2 - apache2 configs](#org352083b)
    4.  [cellxgene && cellxgene-gateway](#org0b8bc08)
    5.  [Basic usage](#orgbaa67c6)
    6.  [links](#orga301c60)


<a id="org8535249"></a>

# cellxgene proxy setup

This setup provides example files and short description for setting up apache2 reverse proxy with 
authentication based on mod<sub>auth</sub><sub>form</sub> (well, basic auth) for cellxgene<sub>gateway</sub> processes listening 
on the current or remote hosts.


<a id="org70b949b"></a>

## etc/cellxgene<sub>templates</sub>


<a id="org2593de5"></a>

### group<sub>to</sub><sub>port.map</sub> defines group to port location


<a id="org9d9afed"></a>

### mkcellxgene<sub>config.pl</sub>

-   script which reads etc/cellxgene/group<sub>to</sub><sub>port.map</sub> file and templates and generates systemd, apache2 configs
    and updates html page for apache's mod<sub>auth</sub><sub>form</sub> module
-   deletetion is not implemented
-   runs in root context, since it will write systemd and apache configs


<a id="orga8e4ab3"></a>

### Apache2 template

-   Ldap auth part is optional, here we use OpenLdap where users defined with memberUid atribute
    the <RequireAny/RequireAll> stanza allows users from different groups access only their cellxgene locations 
    group sysop and defined users can access any resourse.
-   see etc/apache2/sites-available/public.conf for the simplest config without authentication


<a id="org2413369"></a>

### systemd.service template:

-   needs properly defined user and a number of ENV variables
-   <group> and <port> will be updated by the mkcellxgene<sub>config.pl</sub> script
-   one might need to call  systemctl enable cellxgene\_<group> to make services start on boot


<a id="org90a423a"></a>

## var/www/

-   html and css files for mod<sub>auth</sub><sub>form</sub>
-   contains the main index.html updated by mkcellxgene<sub>config.pl</sub>


<a id="org352083b"></a>

## etc/apache2 - apache2 configs

-   list of enabled modules (in addition to the default ones) ( you might have different preferences!)
    ssl,rewrite,headers,ldap,session,authnz<sub>ldap,request,session</sub><sub>cookie,session</sub><sub>crypto,proxy,proxy</sub><sub>http,proxy</sub><sub>html</sub>
-   sites-available/cellxgene.conf - the main config for http and https virtualhosts, also handles the logout action
    includes cellxgene/\* dir with group configs generated by mkcellxgene<sub>config.pl</sub>
-   public.conf for the public section


<a id="org0b8bc08"></a>

## cellxgene && cellxgene-gateway

-   it is assumed that cellxgene and cellxgene-gateway are installed in cellxgeneUser home dir


<a id="orgbaa67c6"></a>

## Basic usage

1.  Create the data directory for the new group and set appropirate permissions.
    (see the CELLXGENE<sub>DATA</sub> var in the systemd template)
2.  Update /etc/cellxgene<sub>templates</sub>/group<sub>to</sub><sub>port.map</sub>
3.  Call /etc/cellxgene<sub>templates</sub>/mkcellxgene<sub>config.pl</sub> <group> to setup systemd, apache2 config 
    and /var/www/index.html
4.  Start the new systemd service: service cellxgene\_<group> start
5.  Reload apache2 config: service apache2 reload
6.  Navigate to the url and test the application
7.  Debug errors with journalctl -xe and (or) apache2 error log files


<a id="orga301c60"></a>

## Links

-   cellxgene: <https://github.com/chanzuckerberg/cellxgene>
-   cellxgene-gateway: <https://github.com/Novartis/cellxgene-gateway>
-   mod<sub>auth</sub><sub>form</sub>: <https://httpd.apache.org/docs/current/mod/mod_auth_form.html>

